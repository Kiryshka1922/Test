#!/bin/bash

# –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Git hook –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –≤–µ—Ç–∫–∏ –≤ –∫–æ–º–º–∏—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Git hook –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –≤–µ—Ç–∫–∏..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if [ ! -d ".git" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –≤ –∫–æ—Ä–Ω–µ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é hooks –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
mkdir -p .git/hooks

# –°–æ–∑–¥–∞–µ–º prepare-commit-msg hook
cat > .git/hooks/prepare-commit-msg << 'EOF'
#!/bin/bash

# –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ç–µ–∫—É—â–µ–π –≤–µ—Ç–∫–∏
branch_name=$(git symbolic-ref --short HEAD 2>/dev/null)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–µ –Ω–∞ detached HEAD –∏ –≤–µ—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ -n "$branch_name" ] && [ "$branch_name" != "HEAD" ]; then
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—Ç–∫–∏ (main, master, develop, dev)
    case "$branch_name" in
        main|master|develop|dev)
            exit 0
            ;;
    esac
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ merge commit, rebase –∏–ª–∏ amend
    case "$2" in
        merge|squash|commit)
            exit 0
            ;;
    esac
    
    # –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ —Å –∫–æ–º–º–∏—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
    commit_msg_file="$1"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –≤–µ—Ç–∫–∏ –∏–ª–∏ —ç—Ç–æ –Ω–µ –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if [ -s "$commit_msg_file" ]; then
        # –ß–∏—Ç–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É –∫–æ–º–º–∏—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        first_line=$(head -1 "$commit_msg_file")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –≤–µ—Ç–∫–∏
        if [[ "$first_line" =~ ^$branch_name: ]] || [[ "$first_line" =~ ^# ]]; then
            exit 0
        fi
        
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        temp_file=$(mktemp)
        
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–µ—Ç–∫–∏ –≤ –Ω–∞—á–∞–ª–æ, –µ—Å–ª–∏ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω–µ –ø—É—Å—Ç–∞—è
        if [ -n "$(echo "$first_line" | tr -d '[:space:]')" ]; then
            echo "$branch_name: $first_line" > "$temp_file"
            # –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
            tail -n +2 "$commit_msg_file" >> "$temp_file"
        else
            echo "$branch_name: " > "$temp_file"
            cat "$commit_msg_file" >> "$temp_file"
        fi
        
        # –ó–∞–º–µ–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
        mv "$temp_file" "$commit_msg_file"
    else
        # –ï—Å–ª–∏ —Ñ–∞–π–ª –ø—É—Å—Ç–æ–π, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å
        echo "$branch_name: " > "$commit_msg_file"
    fi
fi
EOF

# –î–µ–ª–∞–µ–º hook –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x .git/hooks/prepare-commit-msg

echo "‚úÖ Git hook —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
echo "üìã –¢–µ–ø–µ—Ä—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–º–∏—Ç–æ–≤ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–µ—Ç–∫–∏ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –≤ –Ω–∞—á–∞–ª–æ —Å–æ–æ–±—â–µ–Ω–∏—è"
echo "üö´ Hook –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–ª—è –≤–µ—Ç–æ–∫: main, master, develop, dev"
echo "üö´ Hook –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–ª—è merge –∫–æ–º–º–∏—Ç–æ–≤"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
current_branch=$(git branch --show-current 2>/dev/null)
if [ -n "$current_branch" ]; then
    echo "üåø –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $current_branch"
    case "$current_branch" in
        main|master|develop|dev)
            echo "‚ÑπÔ∏è  –ù–∞ —Ç–µ–∫—É—â–µ–π –≤–µ—Ç–∫–µ hook —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥–µ—Ç (—ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è –≤–µ—Ç–∫–∞)"
            ;;
        *)
            echo "‚úÖ –ù–∞ —Ç–µ–∫—É—â–µ–π –≤–µ—Ç–∫–µ hook –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å"
            ;;
    esac
fi